<!DOCTYPE html>
<html>
<head></head>
<body>

<!-- ---------------------------------------- -->
<!-- View two split window -->
<div align="left">
<table style='text-align: left; width: 500px; display:block'>
<tr>

<th id="inputs">

<h1></h1>

<h3>[Step 0]</h3>
<div id="notification"></div>
<div id="error"></div>
<div id="response"></div>
<br>

</th>

<!-- ---------------------------------------- -->
<th id="outputs">
<h3 id="table_h3" style="display:block">[Step 1]</h3>
<!-- ---------------------------------------- -->
<!-- View output in table -->
<input id="input_text" type="text" value="" placeholder="" rows="10" cols="100" style="display:block; text-align: left; height: 50px; width:600px;"><button id="run_selection" onclick="run_selection()">Run Selection</button><button id="run_selection" onclick="print_result()">Print result</button>
<table id="chatbot_output" style='text-align: left; width: 300px; display:none'>
<!-- dynamically add rows here -->
</table>
<!-- ---------------------------------------- -->
</th>

</tr>
</table>
</div>  
<!-- ---------------------------------------- -->

<!-- ---------------------------------------- -->
<!-- CSS -->
<style>
div { padding: 10px; display:block; font-family:courier; font-size:15px; height:10px; }
	
div#notification { position: relative; color: #3236a8; }
div#error { position: relative; color: #bd1f17; }
div#response { display:none; color: #3236a8; }

table {vertical-align: top; border-collapse: collapse; position: relative; z-index: 0; border: 0px solid black;}

tr {vertical-align: top; border: 0px solid black; padding: 10px 10px; }

th, td {vertical-align: top; border: 0px solid black; padding: 10px 10px; }

input#input_text {background-color: #acbdac; border: 0.5px grey; -webkit-border-radius: 5px;-moz-border-radius: 5px;border-radius: 5px;}
</style>


<!-- --------------------------------------------------- -->	  


<script type="module">
import { run_backend_process } from './library_to_run_GitHub_Actions.js';
module.run_backend_process = run_backend_process;
</script>

	
<script>

// -----------------------------------------------

const module = {};
const repoOwner = 'CodeSolutions2';
const repoName = 'my_chatbot';

// -----------------------------------------------
	
async function run_selection() {
	 var filename = 'cb.txt'
	 await module.run_backend_process(filename, document.getElementById("input_text").value+"|"+repoName, 'run_GitHub_Actions')
	 
	
	// document.getElementById('response').innerHTML = 'in progress';
	// await print_response_to_frontend();
	// OR
	await automatic_print_result();
}
	
// -----------------------------------------------


async function automatic_print_result() {

	// Wait for file creation
	var flag = "run";
	var i = 0;
	while (flag == "run" && i < 15) {
		// keep doing GET on the repo files for 'response' until it appears
		flag = await GET_repo_file_info_RESTAPI()
			.then(async function () {
				if (document.getElementById('response').innerHTML.length > 0) {
					await print_response_to_frontend();
					document.getElementById('response').innerHTML = ""; // Reset
					return "stop";
				} else {
					return "run";
				}
			})
			.then(async function(flag) { await new Promise(r => setTimeout(r, 4000)); return flag; })
			.catch(error => { document.getElementById("error").innerHTML = error; });
		i += 1;
		console.log('i: ', i);
	}
}

// -----------------------------------------------
	
async function print_result() {
	await GET_repo_file_info_RESTAPI()
		.then(async function () { await print_response_to_frontend(); })
		.catch(error => { document.getElementById("error").innerHTML = error; });
}




async function GET_repo_file_info_RESTAPI() {
	
	await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents`)
		.then(res => res.json())
		.then(data => {
			// let regexp = new RegExp(`${desired_filename}`, 'g');
			let regexp = new RegExp('response', 'g');
			let file_download_url = '';
			data.forEach(file => {
			      if (file.type === 'file' && file.name.match(regexp)) {
				      // console.log("file.download_url: ", file.download_url);
				      file_download_url = file.download_url;
			      }
			});
			return file_download_url;
		})
		.then(async function (file_download_url) { 
			// console.log("file_download_url: ", file_download_url);
			// https://raw.githubusercontent.com/CodeSolutions2/my_chatbot/main/response
			return await fetch(file_download_url); 
		})
		.then(res => res.text())
		.then(async function (text_out) { document.getElementById('response').innerHTML = text_out; })
		.catch(error => { console.log(error); });

}

// -----------------------------------------------
	
async function print_response_to_frontend() {

	document.getElementById("chatbot_output").style.display = "block";
	
	// Print response to Frontend here
	let tbl = document.getElementById("chatbot_output");
	let tblBody = document.createElement("tbody");
	
	// Add to Frontend: Create a cellText OR textarea
	let row = document.createElement("tr");
	let cell = document.createElement("td");
	cell.style.backgroundColor = "#cacccf";
	let cellText = document.createTextNode(`User: ${document.getElementById("input_text").value}`);
	cell.appendChild(cellText);
	cell.style.border = "10px solid rgba(0, 0, 0, 0)";
	row.appendChild(cell);
	tblBody.appendChild(row);
	tbl.appendChild(tblBody);
	
	// Add chatbot output to Frontend: Create a cellText OR textarea
	row = document.createElement("tr");
	cell = document.createElement("td");
	cell.style.backgroundColor = "#dbc49e";
	cellText = document.createTextNode(`Chatbot: ${document.getElementById('response').innerHTML}`);
	cell.appendChild(cellText);
	cell.style.border = "10px solid rgba(0, 0, 0, 0)";
	row.appendChild(cell);
	tblBody.appendChild(row);
	tbl.appendChild(tblBody);

	// Reset response
	document.getElementById('response').innerHTML = "";
	
}

// -----------------------------------------------

</script>

  
</body>
</html>
