<!DOCTYPE html>
<html>
<head></head>
<body>

<!-- ---------------------------------------- -->
<!-- View two split window -->
<div align="left">
<table style='text-align: left; width: 500px; display:block'>
<tr>

<th id="inputs">

<h1></h1>

<h3>[Step 0] Select a chatbot model</h3>
<fieldset>
<input type="radio" id="openAI3_5" name="radio_name" value="openAI3_5" />
<label openAI3_5="openai">OpenAI 3.5</label>
<br>
<input type="radio" id="openAIassistant" name="radio_name" value="openAIassistant" />
<label for="openAIassistant">OpenAI Assistant</label>
<br>
<input type="radio" id="custom_model" name="radio_name" value="custom_model" />
<label for="custom_model">Custom Model</label>
</fieldset>
<br>
<div id="notification"></div>
<div id="error"></div>
<div id="response"></div>
<div id="output_file_path"></div>
<br>

</th>

<!-- ---------------------------------------- -->
<th id="outputs">
<h3 id="table_h3" style="display:block">[Step 1]</h3>
<!-- ---------------------------------------- -->
<!-- View output in table -->
<input id="input_text" type="text" value="" placeholder="" rows="10" cols="100" style="display:block; text-align: left; height: 50px; width:600px;"><button id="run_selection" onclick="run_selection()">Run Selection</button><button id="run_selection" onclick="print_result()">Print result</button>
<table id="chatbot_output" style='text-align: left; width: 300px; display:none'>
<!-- dynamically add rows here -->
</table>
<!-- ---------------------------------------- -->
</th>

</tr>
</table>
</div>  
<!-- ---------------------------------------- -->

<!-- ---------------------------------------- -->
<!-- CSS -->
<style>
div { padding: 10px; display:block; font-family:courier; font-size:15px; height:10px; }
	
div#notification { position: relative; color: #3236a8; }
div#error { position: relative; color: #bd1f17; }
div#response { display:none; color: #3236a8; }
div#output_file_path { display:none; }

table {vertical-align: top; border-collapse: collapse; position: relative; z-index: 0; border: 0px solid black;}

tr {vertical-align: top; border: 0px solid black; padding: 20px 10px; }

th, td {vertical-align: top; border: 0px solid black; padding: 20px 10px; }

input#input_text {background-color: #acbdac; border: 0.5px grey; -webkit-border-radius: 5px;-moz-border-radius: 5px;border-radius: 5px;}
</style>


<!-- --------------------------------------------------- -->

<!-- Way 0 -->
<!-- <script type="text/javascript" src="library_to_run_GitHub_Actions.js"></script>
Loading failed for the <script> with source “https://codesolutions2.github.io/my_chatbot/library_to_run_GitHub_Actions.js”.
Uncaught (in promise) ReferenceError: run_backend_process is not defined -->

<!-- Way 1 -->
<!-- <script type="module">
import { run_backend_process } from "./library_to_run_GitHub_Actions.js";
module.run_backend_process = run_backend_process;
</script>
<!-- https://codesolutions2.github.io/my_chatbot/library_to_run_GitHub_Actions.js
Loading module from “https://codesolutions2.github.io/my_chatbot/library_to_run_GitHub_Actions.js” was blocked because of a disallowed MIME type (“text/html”). -->

<!-- Way 2 -->
<script type="module" src="./index.js"></script>

<!-- --------------------------------------------------- -->


<script>

// -----------------------------------------------

// Way 1
// const module = {};
	
// -----------------------------------------------
	
window.addEventListener('beforeunload', function() {
    window.location.href = window.location.href + '?nocache=' + new Date().getTime();
});

// -----------------------------------------------
	
async function run_selection() {

	var RepoAobj = {};
	
	const openAI3_5 = document.getElementById("openAI3_5").checked;
	const openAIassistant = document.getElementById("openAIassistant").checked;
	const custom_model = document.getElementById("custom_model").checked;
	
	RepoAobj.repoOwner = 'CodeSolutions2';
	RepoAobj.repoA_name = 'my_chatbot';  // *** Change each application ***
	
	if (openAI3_5 == true && openAIassistant == false && custom_model == false) {
		RepoAobj.foldername = 'openAI3_5';
		await selection_steps(RepoAobj);
	}
	if (openAI3_5 == false && openAIassistant == true && custom_model == false) {
		RepoAobj.foldername = 'openAIassistant';
		await selection_steps(RepoAobj);
	}
	if (openAI3_5 == false && openAIassistant == false && custom_model == true) {
		RepoAobj.foldername = 'custom_model';
		document.getElementById('response').textContent = "In progress";
		await print_response_to_frontend();
	}
	if (openAI3_5 == false && openAIassistant == false && custom_model == false) {
		document.getElementById('error').innerHTML = "Please select a chatbot model.";
	}
}

async function selection_steps(RepoAobj) {

	// RepoAobj.repoOwner, RepoAobj.repoA_name, RepoAobj.foldername
  
	RepoAobj.filename = 'cb.txt';
	RepoAobj.input = document.getElementById("input_text").value+"|"+RepoAobj.repoA_name;
	RepoAobj.repoB_name = 'frontend_backend_message_passing_central_repository_v0';

	// Save file name to DOM
	document.getElementById('output_file_path').innerHTML = RepoAobj.foldername+'_response';
	
	// await module.run_backend_process(RepoAobj); // Way 1
	await run_backend_process(RepoAobj);

	// RepoAobj.repoOwner, RepoAobj.repoA_name, RepoAobj.foldername, RepoAobj.filename, RepoAobj.input, RepoAobj.repoB_name
	
	await automatic_print_result()
}

// -----------------------------------------------

async function automatic_print_result() {

	// Wait for file creation
	var flag = "run";
	var i = 0;
	while (flag == "run" && i < 15) {
		// keep doing GET on the repo files for 'response' until it appears
		flag = await GET_repo_file_info_RESTAPI_fast()
			.then(async function (text_out) {
				console.log('text_out: ', text_out);
				
				if (text_out != '404: Not Found') {
					document.getElementById('response').textContent = text_out;
					await print_response_to_frontend();
					return "stop";
				} else {
					return "run";
				}
			})
			.then(async function(flag) { await new Promise(r => setTimeout(r, 10000)); return flag; })
			.catch(error => { document.getElementById("error").innerHTML = error; });
		i += 1;
		console.log('i: ', i);
	}
}
	
// -----------------------------------------------
	
async function print_result() {
	await GET_repo_file_info_RESTAPI_fast()
		.then(async function (text_out) { 
			if (text_out != '404: Not Found') {
				document.getElementById('response').textContent = text_out;
				await print_response_to_frontend(); 
			}
		})
		.catch(error => { document.getElementById("error").innerHTML = error; });
}


async function GET_repo_file_info_RESTAPI_fast() {
	return await fetch(`https://raw.githubusercontent.com/CodeSolutions2/my_chatbot/main/${document.getElementById('output_file_path').innerHTML}`)
		.then(res => res.text())
		.then(async function (text_out) { return  text_out; })
		.catch(error => { console.log(error); });
}

// -----------------------------------------------
	
async function print_response_to_frontend() {

	document.getElementById("chatbot_output").style.display = "block";
	
	// Print response to Frontend here
	let tbl = document.getElementById("chatbot_output");
	let tblBody = document.createElement("tbody");
	
	// Add to Frontend: Create a cellText OR textarea
	let row = document.createElement("tr");
	let cell = document.createElement("td");
	cell.style.backgroundColor = "#cacccf";
	let cellText = document.createTextNode(`User: ${document.getElementById("input_text").value}`);
	cell.appendChild(cellText);
	cell.style.border = "10px solid rgba(0, 0, 0, 0)";
	row.appendChild(cell);
	tblBody.appendChild(row);
	tbl.appendChild(tblBody);
	
	// Add chatbot output to Frontend: Create a cellText OR textarea
	row = document.createElement("tr");
	cell = document.createElement("td");
	cell.style.backgroundColor = "#dbc49e";
	cellText = document.createTextNode(`Chatbot: ${document.getElementById('response').textContent}`);
	cell.appendChild(cellText);
	cell.style.border = "10px solid rgba(0, 0, 0, 0)";
	row.appendChild(cell);
	tblBody.appendChild(row);
	tbl.appendChild(tblBody);

	// Reset response
	document.getElementById('response').textContent = "";
	
}

// -----------------------------------------------



</script>

  
</body>
</html>
